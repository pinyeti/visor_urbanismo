pipeline {
    agent any

    stages {
        stage('Clonar repositorio') {
            steps {
                // Clonar tu repositorio desde GitHub o cualquier otro sistema de control de versiones
                checkout scm
            }
        }

        stage('Eliminar contenedor y imagen anteriores') {
            steps {
                // Detener y eliminar el contenedor antiguo (si existe)
                sh 'docker stop jenkins_visor_local || true'
                sh 'docker rm jenkins_visor_local || true'
                
                // Eliminar la imagen Docker anterior (si existe)
                sh 'docker rmi jenkins_visor:latest || true'
            }
        }

        stage('Construir imagen Docker Visor') {
            steps {
                // Obtener el número de compilación actual
                // def buildNumber = currentBuild.number
                
                // Crear un tag de imagen Docker con el número de compilación
                def dockerTag = "jenkins_visor:latest"
                
                // Ejecutar el comando 'docker build' para construir la nueva imagen con el tag incremental
                sh "docker build -t ${dockerTag} ."
            }
        }

        stage('Ejecutar el nuevo contenedor Docker Visor') {
            steps {
                // Ejecutar el nuevo contenedor Docker
                sh 'docker run -d --name jenkins_visor_local -e DATABASE_HOST=host.docker.internal -e DATABASE_PORT=5432 -p 3001:3000 jenkins_visor:latest'
            }
        }

    }

    post {
        success {
            echo 'La construcción y ejecución del contenedor Docker se completaron exitosamente.'
        }
        failure {
            echo 'Hubo un problema durante la construcción y/o ejecución del contenedor Docker.'
        }
    }
}
